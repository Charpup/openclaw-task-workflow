spec_version: "1.0"
module_name: "task_workflow_v2"
skill_name: "task-workflow-v2"
description: "智能任务调度系统 - 支持依赖分析、复杂度排序、动态插入的增强型任务工作流"
author: "Galatea"
version: "2.0.0"

interfaces:
  - name: "TaskNode"
    type: "class"
    description: "任务节点，包含元数据、依赖、复杂度信息"
    
    properties:
      - name: "id"
        type: "str"
        description: "任务唯一标识"
      - name: "name"
        type: "str"
        description: "任务名称"
      - name: "description"
        type: "str"
        description: "任务描述"
      - name: "depends_on"
        type: "list[str]"
        description: "依赖的任务ID列表"
        default: []
      - name: "estimated_time"
        type: "str"
        description: "预估时间 (short/medium/long)"
        default: "medium"
      - name: "tool_calls_estimate"
        type: "int"
        description: "预估工具调用数"
        default: 5
      - name: "decision_points"
        type: "int"
        description: "需要决策的关键点数量"
        default: 0
      - name: "complexity_score"
        type: "float"
        description: "复杂度评分 (1-10)"
        computed: true
      - name: "status"
        type: "str"
        description: "任务状态 (pending/running/completed/failed)"
        default: "pending"
    
    methods:
      - name: "calculate_complexity"
        signature: "() -> float"
        description: "计算任务复杂度评分"
        contract:
          preconditions:
            - "estimated_time is one of ['short', 'medium', 'long']"
            - "tool_calls_estimate >= 0"
            - "decision_points >= 0"
          postconditions:
            - "return value is between 1.0 and 10.0"
        test_cases:
          - id: "TC-COMP-001"
            name: "简单任务"
            input:
              estimated_time: "short"
              tool_calls_estimate: 2
              decision_points: 0
            expected:
              complexity_score: 1.4
          - id: "TC-COMP-002"
            name: "中等复杂度"
            input:
              estimated_time: "medium"
              tool_calls_estimate: 8
              decision_points: 2
            expected:
              complexity_score: 7.6
          - id: "TC-COMP-003"
            name: "复杂任务"
            input:
              estimated_time: "long"
              tool_calls_estimate: 15
              decision_points: 5
            expected:
              complexity_score: 10.0

  - name: "DependencyAnalyzer"
    type: "class"
    description: "依赖关系分析器"
    
    methods:
      - name: "build_dependency_graph"
        signature: "(tasks: list[TaskNode]) -> dict"
        description: "构建依赖图"
        contract:
          preconditions:
            - "all task ids are unique"
          postconditions:
            - "graph contains all task ids as keys"
            - "no circular dependencies (raises CircularDependencyError if found)"
        test_cases:
          - id: "TC-DEPS-001"
            name: "无依赖任务"
            input:
              tasks:
                - {id: "A", depends_on: []}
                - {id: "B", depends_on: []}
            expected:
              graph: {A: [], B: []}
          - id: "TC-DEPS-002"
            name: "线性依赖 A->B->C"
            input:
              tasks:
                - {id: "A", depends_on: []}
                - {id: "B", depends_on: ["A"]}
                - {id: "C", depends_on: ["B"]}
            expected:
              execution_order: ["A", "B", "C"]
          - id: "TC-DEPS-003"
            name: "循环依赖检测"
            input:
              tasks:
                - {id: "A", depends_on: ["C"]}
                - {id: "B", depends_on: ["A"]}
                - {id: "C", depends_on: ["B"]}
            expected:
              error: "CircularDependencyError"

  - name: "TaskScheduler"
    type: "class"
    description: "任务调度器 - 拓扑排序 + 复杂度优化"
    
    properties:
      - name: "max_batch_size"
        type: "int"
        description: "单批次最大任务数"
        default: 10
    
    methods:
      - name: "schedule_tasks"
        signature: "(tasks: list[TaskNode]) -> list[list[TaskNode]]"
        description: "将任务分组为可并行执行的批次"
        contract:
          preconditions:
            - "no circular dependencies"
            - "all dependencies exist"
          postconditions:
            - "respects dependency order (dep before dependent)"
            - "complexity ascending within each level"
            - "each batch size <= max_batch_size"
        test_cases:
          - id: "TC-SCHED-001"
            name: "简单并行"
            input:
              tasks:
                - {id: "A", complexity: 3, depends_on: []}
                - {id: "B", complexity: 1, depends_on: []}
                - {id: "C", complexity: 5, depends_on: []}
            expected:
              batches: [["B", "A", "C"]]  # sorted by complexity
          - id: "TC-SCHED-002"
            name: "依赖链 + 并行"
            input:
              tasks:
                - {id: "A", complexity: 2, depends_on: []}
                - {id: "B", complexity: 4, depends_on: ["A"]}
                - {id: "C", complexity: 1, depends_on: []}
                - {id: "D", complexity: 3, depends_on: ["A"]}
            expected:
              batches: [["C", "A"], ["D", "B"]]  # batch1: C before A (complexity), batch2: D before B
          - id: "TC-SCHED-003"
            name: "批次限制"
            input:
              tasks: 15 independent tasks
              max_batch_size: 10
            expected:
              batch_count: 2
              first_batch_size: 10

  - name: "DynamicTaskManager"
    type: "class"
    description: "动态任务管理器 - 支持运行时插入"
    
    properties:
      - name: "running_tasks"
        type: "list[str]"
        description: "正在执行的任务ID"
      - name: "pending_tasks"
        type: "list[TaskNode]"
        description: "待执行的任务队列"
      - name: "completed_tasks"
        type: "list[str]"
        description: "已完成的任务ID"
    
    methods:
      - name: "insert_task"
        signature: "(task: TaskNode) -> bool"
        description: "插入新任务到队列"
        contract:
          preconditions:
            - "task.id is unique"
          postconditions:
            - "if any dep is running/completed: add to pending and reschedule"
            - "if deps all pending: integrate into pending queue"
            - "returns True if inserted successfully"
        test_cases:
          - id: "TC-DYN-001"
            name: "插入到待执行队列"
            input:
              current_pending: ["A", "B"]
              new_task: {id: "C", depends_on: [], complexity: 2}
            expected:
              pending_order: ["C", "A", "B"]  # C inserted by complexity
          - id: "TC-DYN-002"
            name: "依赖运行中任务"
            input:
              running: ["A"]
              new_task: {id: "B", depends_on: ["A"]}
            expected:
              pending: ["B"]
              wait_for: "A"
          - id: "TC-DYN-003"
            name: "依赖已完成任务"
            input:
              completed: ["A"]
              new_task: {id: "B", depends_on: ["A"]}
            expected:
              can_execute_immediately: true
              pending: ["B"]

scenarios:
  - id: "E2E-001"
    name: "完整任务调度流程"
    given:
      - condition: "5 个任务已定义，含依赖关系"
    when:
      - action: "调用 TaskScheduler.schedule_tasks()"
    then:
      - expectation: "返回正确的批次分组"
      - expectation: "依赖关系被满足"
      - expectation: "复杂度低者优先"

  - id: "E2E-002"
    name: "动态插入任务"
    given:
      - condition: "任务调度已开始"
      - condition: "批次1正在执行"
    when:
      - action: "插入新任务 X"
    then:
      - expectation: "批次1继续执行不中断"
      - expectation: "新任务插入到后续批次"

  - id: "E2E-003"
    name: "循环依赖检测"
    given:
      - condition: "任务定义包含循环依赖"
    when:
      - action: "调用 DependencyAnalyzer"
    then:
      - expectation: "抛出 CircularDependencyError"
      - expectation: "返回详细的循环路径"

acceptance_criteria:
  functional:
    - "所有单元测试通过 (pytest tests/unit -v)"
    - "所有集成测试通过 (pytest tests/integration -v)"
    - "代码覆盖率 >= 85%"
    - "支持最多 100 个任务的调度"
    - "调度算法时间复杂度 O(V + E)"
  
  non_functional:
    - "调度 50 个任务 < 100ms"
    - "循环依赖检测 < 50ms"
    - "API 文档完整"
    - "SKILL.md v2 包含使用示例"

constraints:
  - "单批次最大任务数: 10 (可配置 5-20)"
  - "不支持任务取消 (v2.1 考虑)"
  - "复杂度计算基于预估，非实时"
